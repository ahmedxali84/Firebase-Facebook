<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - Hashbook</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <style>
/* General Styles */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Poppins', sans-serif;
}

body {
    background: #1E1E1E;
    color: #EAEAEA;
    display: flex;
    min-height: 100vh;
    flex-direction: row;
    overflow-y: auto;
}

/* Light Theme */
.light-theme {
    background: #f5f5f5;
    color: #333;
}

.light-theme .sidebar {
    background-color: #ffffff;
    box-shadow: 4px 0 10px rgba(0, 0, 0, 0.1);
}

.light-theme .sidebar a {
    color: #333;
}

.light-theme .sidebar a:hover {
    background-color: #f0f0f0;
    color: #000;
}

.light-theme .sidebar .theme-toggle {
    background: #00B8A9;
}

.light-theme .sidebar .theme-toggle:hover {
    background: #007D76;
}

.light-theme .post-form {
    background: #ffffff;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
}

.light-theme .post-form h3 {
    color: #00B8A9;
}

.light-theme .post {
    background: #ffffff;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    color: #333;
}

.light-theme .post small {
    color: #666;
}

.light-theme .profile-header img {
    border-color: #00B8A9;
}

.light-theme .profile-info h1 {
    color: #00B8A9;
}

.light-theme .profile-uid {
    color: #666;
}

.light-theme .profile-bio {
    color: #333;
    border-top: 1px solid rgba(0, 0, 0, 0.2);
}

.light-theme .post-form textarea {
    background: #f0f0f0;
    color: #333;
    border-color: #ddd;
}

.light-theme .post-form textarea:focus {
    border-color: #00B8A9;
    box-shadow: 0 0 10px rgba(0, 184, 169, 0.5);
}

/* Sidebar */
.sidebar {
    width: 280px;
    background-color: #292929;
    padding: 40px 30px;
    position: fixed;
    top: 0;
    left: 0;
    height: 100%;
    overflow-y: auto;
    box-shadow: 4px 0 10px rgba(0, 0, 0, 0.5);
    transition: 0.3s;
}

.sidebar .logo {
    font-size: 30px;
    font-weight: 700;
    color: #00B8A9;
    text-align: center;
    margin-bottom: 30px;
}

.sidebar a {
    display: block;
    color: #B0E4E1;
    padding: 14px 22px;
    text-decoration: none;
    transition: 0.3s;
    border-radius: 10px;
    margin-bottom: 10px;
}

.sidebar a:hover {
    background-color: #007D76;
    color: #fff;
}

.sidebar .logout-btn,
.sidebar .theme-toggle {
    background: #007D76;
    color: white;
    padding: 14px;
    text-align: center;
    cursor: pointer;
    border-radius: 20px;
    transition: 0.3s;
    margin-bottom: 10px;
}

.sidebar .logout-btn:hover,
.sidebar .theme-toggle:hover {
    background: #005A52;
}

/* Main Container */
.container {
    margin-left: 300px;
    padding: 40px;
    width: calc(100% - 300px);
    transition: 0.3s;
}

/* Profile Header */
.profile-header {
    display: flex;
    align-items: center;
    margin-bottom: 30px;
    animation: fadeIn 1s ease-in-out;
}

.profile-header img {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    margin-right: 20px;
    border: 4px solid #00B8A9;
    transition: transform 0.3s ease;
}

.profile-header img:hover {
    transform: scale(1.1);
}

/* Profile Info */
.profile-info {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.profile-info h1 {
    font-size: 32px;
    color: #00B8A9;
    margin: 0;
}

.profile-uid {
    font-size: 14px;
    color: #B0E4E1;
    margin: 0;
}

/* Bio Section */
.profile-bio {
    font-size: 18px; /* Avg heading size */
    font-weight: 500;
    color: #EAEAEA;
    margin-top: 5px;
    padding: 5px 0;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    width: fit-content;
}

/* Post Form */
.post-form {
    background: #2A2A2A;
    padding: 25px;
    border-radius: 20px;
    margin-bottom: 30px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    animation: fadeIn 1s ease-in-out;
}

.post-form h3 {
    font-size: 24px;
    color: #00B8A9;
    margin-bottom: 20px;
}

.post-form textarea {
    width: 100%;
    padding: 10px;
    border-radius: 10px;
    background: #333;
    color: #EAEAEA;
    border: 1px solid #555;
    margin-bottom: 15px;
    resize: vertical;
    transition: border-color 0.3s ease;
}

.post-form textarea:focus {
    outline: none;
    border-color: #00B8A9;
    box-shadow: 0 0 10px rgba(0, 184, 169, 0.5);
}

.post-form input[type="file"] {
    margin-bottom: 15px;
}

.post-form button {
    padding: 12px 20px;
    background: #00B8A9;
    color: white;
    font-size: 16px;
    font-weight: bold;
    border: none;
    border-radius: 15px;
    cursor: pointer;
    transition: 0.3s;
}

.post-form button:hover {
    background: #007D76;
    transform: translateY(-3px);
}

/* Posts Section */
.posts-container {
    margin-top: 20px;
}

/* Individual Post */
.post {
    background: #292929;
    padding: 20px;
    border-radius: 15px;
    margin-bottom: 15px;
    color: #EAEAEA;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    animation: fadeIn 0.5s ease-in-out;
}

.post .user-info {
    display: flex;
    align-items: center;
    margin-bottom: 10px;
}

.post .user-info img {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    margin-right: 15px;
    border: 2px solid #00B8A9;
}

.post .user-info a {
    color: #00B8A9;
    text-decoration: none;
    font-weight: bold;
}

.post .user-info a:hover {
    text-decoration: underline;
}

.post p {
    margin: 10px 0;
}

.post img {
    max-width: 100%;
    border-radius: 10px;
    margin-top: 10px;
}

.post small {
    color: #B0E4E1;
    font-size: 12px;
}

/* Animations */
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideIn {
    from { transform: translateY(20px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

/* Responsive Design */
@media (max-width: 1115px) {
    .sidebar {
        display: none;
    }

    .container {
        margin-left: 0;
        width: 100%;
        padding: 70px 20px 20px;
    }

    .profile-header {
        flex-direction: column;
        align-items: flex-start;
    }

    .profile-header img {
        width: 80px;
        height: 80px;
        margin-right: 0;
        margin-bottom: 10px;
    }

    .profile-header h1 {
        font-size: 24px;
    }
}

    </style>
</head>
<body>
    
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo">Hashbook</div>
        <a href="../dashboard.html">Home</a>
        <a href="./index.html">Profile</a>
        <a href="../Messaging/index.html">Messages</a>
        <a href="../settings/index.html">Settings</a>
        <a href="../Friends/index.html">Friends</a>
        <div class="logout-btn">Logout</div>
    </div>

    <div class="container">
        <!-- Profile Header -->
        <div class="profile-header">
            <label for="profile-picture-input">
                <img id="profile-picture" src="../pfp.jpg" alt="Profile Picture">
            </label>
            <input type="file" id="profile-picture-input" accept="image/*" style="display: none;">
            <div class="profile-info">
                <h1 id="profile-name">Loading...</h1>
                <div class="profile-uid" id="profile-uid">Random UID: Loading...</div>
                <div class="profile-bio" id="profile-bio">Loading bio...</div>
            </div>
        </div>

        <!-- Post Form -->
        <div class="post-form">
            <h3>Create a New Post</h3>
            <textarea id="post-text" rows="4" placeholder="What's on your mind?"></textarea>
            <input type="file" id="post-image" accept="image/*">
            <button id="post-btn">Post</button>
        </div>

        <!-- User's Posts -->
        <div class="posts-container" id="posts-container"></div>
    </div>

    <!-- SweetAlert2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { 
            getFirestore, collection, addDoc, getDocs, query, where, doc, deleteDoc, updateDoc, serverTimestamp, getDoc, setDoc 
        } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-storage.js";
        import { formatDistanceToNow } from 'https://cdn.skypack.dev/date-fns';
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCKv8qaAw8bcHwprm1IRA1NWyXQ47tBWRY",
            authDomain: "facebook-1751a.firebaseapp.com",
            projectId: "facebook-1751a",
            storageBucket: "facebook-1751a.appspot.com",
            messagingSenderId: "852573765318",
            appId: "1:852573765318:web:00d8edf77b925d7a5e21c7",
            measurementId: "G-RZBV4M5Z2F"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        
        // ðŸ”¹ Generate a Random UID
        function generateRandomUID() {
            const characters = 'abcdefghijklmnopqrstuvwxyz0123456789';
            let randomUID = '';
            for (let i = 0; i < 8; i++) {
                randomUID += characters.charAt(Math.floor(Math.random() * characters.length));
            }
            return randomUID;
        }
        
        // ðŸ”¹ Get User ID from URL
        function getUserIdFromURL() {
            const params = new URLSearchParams(window.location.search);
            return params.get("userId");
        }
        
        // ðŸ”¹ Get User ID by Random UID
        async function getUserIdByRandomUID(randomUID) {
            try {
                const usersRef = collection(db, "users");
                const q = query(usersRef, where("randomUID", "==", randomUID));
                const querySnapshot = await getDocs(q);
                
                if (!querySnapshot.empty) {
                    return querySnapshot.docs[0].id; // Return the first matching user ID
                } else {
                    console.error("No user found with this random UID:", randomUID);
                    return null;
                }
            } catch (error) {
                console.error("Error finding user by random UID:", error);
                return null;
            }
        }
        
        // ðŸ”¹ Get Random UID by User ID
        async function getRandomUIDByUserId(userId) {
            try {
                const userRef = doc(db, "users", userId);
                const userDoc = await getDoc(userRef);
                
                if (userDoc.exists()) {
                    return userDoc.data().randomUID;
                } else {
                    console.error("No user found with this user ID:", userId);
                    return null;
                }
            } catch (error) {
                console.error("Error finding random UID by user ID:", error);
                return null;
            }
        }
        
        // ðŸ”¹ Load Profile Data
        async function loadProfile(userId) {
            const profileName = document.getElementById("profile-name");
            const profileUID = document.getElementById("profile-uid");
            const profileBio = document.getElementById("profile-bio");
            const profilePicture = document.getElementById("profile-picture");
        
            try {
                const userRef = doc(db, "users", userId);
                const userDoc = await getDoc(userRef);
        
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    // Fixed typo: changed 'uername' to 'displayName' and added fallback
                    profileName.textContent = userData.displayName || "Anonymous";
                    profileUID.textContent = `UID: ${userData.randomUID || "Not Set"}`;
                    profileBio.textContent = userData.bio || "You can add your bio from profile management.";
                    profilePicture.src = userData.photoURL || "../pfp.jpg";
                } else {
                    console.error("User document does not exist.");
                }
            } catch (error) {
                console.error("Error loading profile:", error);
            }
        }
        
        // ðŸ”¹ Load Posts
        async function loadPosts(userId) {
            const postsContainer = document.getElementById("posts-container");
            postsContainer.innerHTML = ""; // Clear existing posts
        
            try {
                const postsRef = collection(db, "posts");
                const q = query(postsRef, where("userId", "==", userId));
                const querySnapshot = await getDocs(q);
        
                if (querySnapshot.empty) {
                    postsContainer.innerHTML = "<p>No posts found.</p>";
                    return;
                }
        
                querySnapshot.forEach((doc) => {
                    const post = doc.data();
                    const postElement = document.createElement("div");
                    postElement.classList.add("post");
                    postElement.innerHTML = `
                        <div class="user-info">
                            <img src="${post.userPhotoURL || "../pfp.jpg"}" alt="User Photo">
                            <a href="#">${post.userName || "Anonymous"}</a>
                        </div>
                        <p>${post.text}</p>
                        ${post.imageURL ? `<img src="${post.imageURL}" alt="Post Image">` : ""}
                        <small>Posted ${formatDistanceToNow(post.createdAt?.toDate() || new Date(), { addSuffix: true })}</small>
                    `;
                    postsContainer.appendChild(postElement);
                });
            } catch (error) {
                console.error("Error loading posts:", error);
            }
        }
        
        // ðŸ”¹ Handle New Post Submission
        async function handlePostSubmit() {
            const user = auth.currentUser;
            if (!user) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'You must be logged in to create a post.'
                });
                return;
            }
        
            const postText = document.getElementById("post-text").value.trim();
            const postImage = document.getElementById("post-image").files[0];
        
            if (!postText && !postImage) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Empty Post',
                    text: 'Please enter text or upload an image to create a post.'
                });
                return;
            }
        
            try {
                const userRef = doc(db, "users", user.uid);
                const userDoc = await getDoc(userRef);
        
                if (!userDoc.exists()) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Your user data could not be found.'
                    });
                    return;
                }
        
                const userData = userDoc.data();
                const postData = {
                    userId: user.uid,
                    userName: userData.displayName || "Anonymous",
                    userPhotoURL: userData.photoURL || "../pfp.jpg",
                    text: postText,
                    createdAt: serverTimestamp()
                };
        
                if (postImage) {
                    const storageRef = ref(storage, `posts/${user.uid}/${Date.now()}_${postImage.name}`);
                    await uploadBytes(storageRef, postImage);
                    postData.imageURL = await getDownloadURL(storageRef);
                }
        
                await addDoc(collection(db, "posts"), postData);
        
                Swal.fire({
                    icon: 'success',
                    title: 'Success',
                    text: 'Your post has been created!'
                });
        
                // Clear the form
                document.getElementById("post-text").value = "";
                document.getElementById("post-image").value = "";
        
                // Reload posts
                loadPosts(user.uid);
            } catch (error) {
                console.error("Error creating post:", error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Failed to create post. Please try again.'
                });
            }
        }
        
        // ðŸ”¹ Theme Management Functions

        // Save theme preference to localStorage
        function saveThemePreference(theme) {
            localStorage.setItem("theme", theme);
        }

        // Apply theme from localStorage
        function applyTheme() {
            const savedTheme = localStorage.getItem("theme");
            const themeToggle = document.getElementById("theme-toggle");
            
            if (savedTheme === "light") {
                document.body.classList.add("light-theme");
                if (themeToggle) themeToggle.textContent = "Dark Mode";
            } else {
                document.body.classList.remove("light-theme");
                if (themeToggle) themeToggle.textContent = "Light Mode";
            }
        }

        // Toggle between light and dark themes
        function toggleTheme() {
            if (document.body.classList.contains("light-theme")) {
                document.body.classList.remove("light-theme");
                saveThemePreference("dark");
                document.getElementById("theme-toggle").textContent = "Light Mode";
            } else {
                document.body.classList.add("light-theme");
                saveThemePreference("light");
                document.getElementById("theme-toggle").textContent = "Dark Mode";
            }
        }
        
        // ðŸ”¹ Initialize Page
        document.addEventListener("DOMContentLoaded", () => {
            // Apply saved theme
            applyTheme();
            
            // Theme toggle button event listener
            const themeToggle = document.getElementById("theme-toggle");
            if (themeToggle) {
                themeToggle.addEventListener("click", toggleTheme);
            }
            
            const postBtn = document.getElementById("post-btn");
            if (postBtn) {
                postBtn.addEventListener("click", handlePostSubmit);
            }
        
            // ðŸ”¹ Logout functionality
            document.querySelectorAll(".logout-btn").forEach(button => {
                button.addEventListener("click", () => {
                    signOut(auth).then(() => {
                        window.location.href = "../index.html";
                    }).catch((error) => {
                        console.error("Error signing out:", error);
                    });
                });
            });
        
            // ðŸ”¹ Load profile and posts when the page loads
            onAuthStateChanged(auth, async (user) => {
                if (!user) {
                    window.location.href = "../index.html";
                } else {
                    try {
                        const userRef = doc(db, "users", user.uid);
                        const userDoc = await getDoc(userRef);
        
                        if (!userDoc.exists()) {
                            // Create user profile if it doesn't exist
                            const randomUID = generateRandomUID();
                            await setDoc(userRef, { 
                                displayName: user.displayName || "Anonymous", 
                                randomUID: randomUID, 
                                createdAt: serverTimestamp() 
                            });
                        }
        
                        const userId = getUserIdFromURL() || user.uid;
                        if (userId) {
                            loadProfile(userId);
                            loadPosts(userId);
                        }
                    } catch (error) {
                        console.error("Error initializing user:", error);
                        Swal.fire({
                            icon: 'error',
                            title: 'Initialization Error',
                            text: 'There was a problem loading your profile. Please refresh the page.'
                        });
                    }
                }
            });
        });
    </script>
</body>
</html>
