<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hashbook</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    /* Advanced Styling */
    :root {
      --primary-color: #00B8A9;
      --secondary-color: #007D76;
      --background-color: #1E1E1E;
      --text-color: #EAEAEA;
      --navbar-bg: #292929;
      --hover-bg: #007D76;
      --hover-text: #ffffff;
      --logout-bg: #007D76;
      --logout-hover-bg: #005A52;
      --shadow: rgba(0, 0, 0, 0.5);
      --card-bg: #2C2C2C;
      --border-radius: 15px;
      --transition-speed: 0.3s;
      --gradient-primary: linear-gradient(135deg, #00B8A9, #007D76);
      --gradient-secondary: linear-gradient(135deg, #007D76, #00B8A9);
      --glow: 0 0 15px rgba(0, 184, 169, 0.7);
    }

    [data-theme="light"] {
      --primary-color: #007D76;
      --secondary-color: #00B8A9;
      --background-color: #F5F5F5;
      --text-color: #333;
      --navbar-bg: #ffffff;
      --hover-bg: #e0e0e0;
      --hover-text: #000;
      --logout-bg: #007D76;
      --logout-hover-bg: #005A52;
      --shadow: rgba(0, 0, 0, 0.1);
      --card-bg: #ffffff;
      --gradient-primary: linear-gradient(135deg, #007D76, #00B8A9);
      --gradient-secondary: linear-gradient(135deg, #00B8A9, #007D76);
      --glow: 0 0 15px rgba(0, 125, 118, 0.5);
    }

    /* General Styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Poppins', sans-serif;
    }

    body {
      background: var(--background-color);
      color: var(--text-color);
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      overflow-y: auto;
      transition: background-color var(--transition-speed), color var(--transition-speed);
    }

    /* Navbar */
    .navbar {
      width: 100%;
      background-color: var(--navbar-bg);
      padding: 15px 20px;
      box-shadow: 0 4px 20px var(--shadow);
      position: fixed;
      top: 0;
      left: 0;
      z-index: 1000;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: var(--transition-speed);
    }

    .navbar .logo {
      font-size: 24px;
      font-weight: 700;
      color: var(--primary-color);
      white-space: nowrap;
      text-shadow: var(--glow);
    }

    .navbar .menu {
      display: flex;
      align-items: center;
      gap: 20px;
      overflow-x: auto;
      white-space: nowrap;
    }

    .navbar a {
      color: var(--text-color);
      text-decoration: none;
      padding: 8px 12px;
      border-radius: var(--border-radius);
      transition: var(--transition-speed);
      font-size: 14px;
      position: relative;
    }

    .navbar a::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      width: 0;
      height: 2px;
      background: var(--primary-color);
      transition: var(--transition-speed);
      transform: translateX(-50%);
    }

    .navbar a:hover::after {
      width: 100%;
    }

    .navbar a:hover {
      color: var(--hover-text);
      background-color: var(--hover-bg);
    }

    .navbar .logout-btn {
      background: var(--logout-bg);
      color: white;
      padding: 8px 12px;
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: var(--transition-speed);
      box-shadow: var(--glow);
    }

    .navbar .logout-btn:hover {
      background: var(--logout-hover-bg);
      transform: translateY(-2px);
    }

    /* Main Container */
    .container {
      margin-top: 80px;
      padding: 20px;
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: var(--transition-speed);
    }

    /* Story Box */
    .story-box {
      position: fixed;
      top: 100px;
      right: 20px;
      background: var(--card-bg);
      width: 60px;
      height: 60px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: var(--glow);
      cursor: pointer;
      transition: var(--transition-speed);
    }

    .story-box:hover {
      transform: scale(1.1);
    }

    .story-box .add-icon {
      font-size: 24px;
      color: var(--primary-color);
    }

    /* Story Modal */
    .story-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .story-modal.active {
      display: flex;
    }

    .modal-content {
      background: var(--card-bg);
      padding: 25px;
      border-radius: var(--border-radius);
      box-shadow: 0 5px 25px var(--shadow);
      width: 100%;
      max-width: 500px;
      position: relative;
    }

    .close-modal {
      position: absolute;
      top: 15px;
      right: 15px;
      font-size: 24px;
      color: var(--text-color);
      cursor: pointer;
      transition: var(--transition-speed);
    }

    .close-modal:hover {
      color: var(--primary-color);
    }

    .modal-content h3 {
      font-size: 24px;
      color: var(--primary-color);
      margin-bottom: 20px;
      text-align: center;
      text-shadow: var(--glow);
    }

    .modal-content textarea {
      width: 100%;
      padding: 12px;
      border-radius: var(--border-radius);
      background: var(--background-color);
      color: var(--text-color);
      border: 1px solid var(--hover-bg);
      resize: none;
      transition: var(--transition-speed);
      font-size: 14px;
      margin-bottom: 20px;
    }

    .modal-content textarea:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: var(--glow);
    }

    .modal-content .file-upload-label {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 12px;
      background: var(--background-color);
      border: 1px solid var(--hover-bg);
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: var(--transition-speed);
      margin-bottom: 20px;
    }

    .modal-content .file-upload-label:hover {
      background: var(--hover-bg);
      border-color: var(--primary-color);
    }

    .modal-content .file-upload-label .upload-icon {
      font-size: 18px;
    }

    .modal-content .file-upload-label .upload-text {
      font-size: 14px;
      color: var(--text-color);
    }

    .modal-content .file-upload-input {
      display: none;
    }

    .modal-content .story-button {
      width: 100%;
      padding: 12px 20px;
      background: var(--gradient-primary);
      color: white;
      font-size: 16px;
      font-weight: bold;
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: var(--transition-speed);
      box-shadow: var(--glow);
    }

    .modal-content .story-button:hover {
      opacity: 0.9;
      transform: translateY(-2px);
    }

    /* Story Form */
    .story-form {
      background: var(--card-bg);
      padding: 25px;
      border-radius: var(--border-radius);
      box-shadow: 0 5px 25px var(--shadow);
      margin-bottom: 20px;
      width: 100%;
      max-width: 600px;
      transition: var(--transition-speed);
      display: none; /* Hidden by default */
    }

    .story-form h3 {
      font-size: 24px;
      color: var(--primary-color);
      margin-bottom: 15px;
      text-align: center;
      text-shadow: var(--glow);
    }

    .story-form textarea {
      width: 100%;
      margin-bottom: 15px;
      padding: 12px;
      border-radius: var(--border-radius);
      background: var(--background-color);
      color: var(--text-color);
      border: 1px solid var(--hover-bg);
      resize: none;
      transition: var(--transition-speed);
      font-size: 14px;
    }

    .story-form textarea:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: var(--glow);
    }

    .story-form input[type="file"] {
      width: 100%;
      margin-bottom: 15px;
      padding: 12px;
      border-radius: var(--border-radius);
      background: var(--background-color);
      color: var(--text-color);
      border: 1px solid var(--hover-bg);
      transition: var(--transition-speed);
      font-size: 14px;
    }

    .story-form input[type="file"]:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: var(--glow);
    }

    .story-form button {
      width: 100%;
      padding: 12px 20px;
      background: var(--gradient-primary);
      color: white;
      font-size: 16px;
      font-weight: bold;
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: var(--transition-speed);
      box-shadow: var(--glow);
    }

    .story-form button:hover {
      opacity: 0.9;
      transform: translateY(-2px);
    }

    /* Story View Modal */
    .story-view-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      z-index: 1001;
      justify-content: center;
      align-items: center;
    }

    .story-view-modal.active {
      display: flex;
    }

    .story-content {
      background: var(--card-bg);
      border-radius: var(--border-radius);
      box-shadow: var(--glow);
      width: 90%;
      max-width: 500px;
      position: relative;
      padding: 20px;
      text-align: center;
    }

    .close-story-modal {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 24px;
      color: var(--text-color);
      cursor: pointer;
      transition: var(--transition-speed);
    }

    .close-story-modal:hover {
      color: var(--primary-color);
    }

    .story-media img {
      max-width: 100%;
      max-height: 70vh;
      border-radius: var(--border-radius);
    }

    .story-media p {
      font-size: 18px;
      color: var(--text-color);
      margin: 20px 0;
    }

    .story-controls {
      margin-top: 20px;
    }

    .control-btn {
      background: none;
      border: none;
      font-size: 24px;
      color: var(--text-color);
      cursor: pointer;
      transition: var(--transition-speed);
    }

    .control-btn:hover {
      color: var(--primary-color);
    }

    /* Stories Container */
    .stories-container {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      overflow-x: auto;
      padding: 10px;
    }

    .story-card {
      background: var(--card-bg);
      width: 120px;
      height: 180px;
      border-radius: var(--border-radius);
      box-shadow: var(--glow);
      position: relative;
      overflow: hidden;
      cursor: pointer;
      transition: var(--transition-speed);
    }

    .story-card:hover {
      transform: scale(1.05);
    }

    .story-card img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .story-card .user-info {
      position: absolute;
      bottom: 10px;
      left: 10px;
      display: flex;
      align-items: center;
    }

    .story-card .user-info img {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      border: 2px solid var(--primary-color);
      margin-right: 5px;
    }

    .story-card .user-info span {
      font-size: 14px;
      color: var(--text-color);
      font-weight: 600;
    }

    .story-card .dropdown {
      position: absolute;
      top: 10px;
      right: 10px;
    }

    .story-card .dropdown-btn {
      background: none;
      border: none;
      color: var(--text-color);
      font-size: 20px;
      cursor: pointer;
    }

    .story-card .dropdown-content {
      display: none;
      position: absolute;
      right: 0;
      background: var(--card-bg);
      border-radius: var(--border-radius);
      box-shadow: var(--glow);
      z-index: 1;
    }

    .story-card .dropdown-content button {
      display: block;
      width: 100%;
      padding: 8px 12px;
      background: none;
      border: none;
      color: var(--text-color);
      text-align: left;
      cursor: pointer;
      transition: var(--transition-speed);
    }

    .story-card .dropdown-content button:hover {
      background: var(--hover-bg);
    }

    .story-card .dropdown:hover .dropdown-content {
      display: block;
    }

    /* Posts Section */
    .posts-container {
      margin-top: 20px;
      width: 100%;
      max-width: 600px;
    }

    /* Individual Post */
    .post {
      background: var(--card-bg);
      padding: 20px;
      border-radius: var(--border-radius);
      margin-bottom: 20px;
      color: var(--text-color);
      box-shadow: 0 5px 25px var(--shadow);
      transition: var(--transition-speed);
      position: relative;
    }

    .post:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px var(--shadow);
    }

    .post .user-info {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
    }

    .post .user-info img {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      margin-right: 15px;
      border: 2px solid var(--primary-color);
      box-shadow: var(--glow);
    }

    .post .user-info span {
      font-size: 18px;
      font-weight: 600;
      color: var(--primary-color);
      text-shadow: var(--glow);
    }

    .post .dropdown {
      position: absolute;
      top: 20px;
      right: 20px;
    }

    .post .dropdown-btn {
      background: none;
      border: none;
      color: var(--text-color);
      font-size: 20px;
      cursor: pointer;
    }

    .post .dropdown-content {
      display: none;
      position: absolute;
      right: 0;
      background: var(--card-bg);
      border-radius: var(--border-radius);
      box-shadow: var(--glow);
      z-index: 1;
    }

    .post .dropdown-content button {
      display: block;
      width: 100%;
      padding: 8px 12px;
      background: none;
      border: none;
      color: var(--text-color);
      text-align: left;
      cursor: pointer;
      transition: var(--transition-speed);
    }

    .post .dropdown-content button:hover {
      background: var(--hover-bg);
    }

    .post .dropdown:hover .dropdown-content {
      display: block;
    }

    .post .post-text {
      font-size: 16px;
      line-height: 1.6;
      margin-bottom: 15px;
    }

    .post .post-image {
      width: 100%;
      border-radius: var(--border-radius);
      margin-bottom: 15px;
      box-shadow: var(--glow);
    }

    .post .post-actions {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 15px;
    }

    .post .like-btn {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 18px;
      padding: 8px;
      transition: var(--transition-speed);
      color: var(--text-color);
    }

    .post .like-btn.liked {
      color: red;
      text-shadow: 0 0 10px rgba(255, 0, 0, 0.7);
    }

    .post .like-btn:hover {
      transform: scale(1.1);
    }

    .post .comment-btn {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 18px;
      padding: 8px;
      transition: var(--transition-speed);
      color: var(--text-color);
    }

    .post .comment-btn:hover {
      transform: scale(1.1);
    }

    .post .time-ago {
      font-size: 14px;
      color: var(--sidebar-text);
      margin-bottom: 15px;
    }

    /* Comments Section */
    .comments-container {
      margin-top: 15px;
      padding: 15px;
      background: var(--background-color);
      border-radius: var(--border-radius);
      border: 1px solid var(--hover-bg);
      max-height: 200px;
      overflow-y: auto;
      box-shadow: var(--glow);
    }

    .comments-container h4 {
      font-size: 16px;
      color: var(--primary-color);
      margin-bottom: 10px;
      text-shadow: var(--glow);
    }

    .comment {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }

    .comment img {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      margin-right: 10px;
      border: 1px solid var(--primary-color);
      box-shadow: var(--glow);
    }

    .comment p {
      margin: 0;
      font-size: 14px;
      color: var(--text-color);
    }

    .comment-input {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    .comment-input input {
      flex: 1;
      padding: 8px;
      border-radius: var(--border-radius);
      border: 1px solid var(--hover-bg);
      background: var(--background-color);
      color: var(--text-color);
      transition: var(--transition-speed);
    }

    .comment-input input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: var(--glow);
    }

    .comment-input button {
      padding: 8px 12px;
      background: var(--gradient-primary);
      color: white;
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: var(--transition-speed);
      box-shadow: var(--glow);
    }

    .comment-input button:hover {
      opacity: 0.9;
      transform: translateY(-2px);
    }

    /* Post Form */
    .post-form {
      background: var(--card-bg);
      padding: 25px;
      border-radius: var(--border-radius);
      box-shadow: 0 5px 25px var(--shadow);
      margin-bottom: 20px;
      width: 100%;
      max-width: 600px;
      transition: var(--transition-speed);
    }

    .post-form h3 {
      font-size: 24px;
      color: var(--primary-color);
      margin-bottom: 20px;
      text-align: center;
      text-shadow: var(--glow);
    }

    .post-form .form-group {
      margin-bottom: 20px;
    }

    .post-form textarea {
      width: 100%;
      padding: 12px;
      border-radius: var(--border-radius);
      background: var(--background-color);
      color: var(--text-color);
      border: 1px solid var(--hover-bg);
      resize: none;
      transition: var(--transition-speed);
      font-size: 14px;
    }

    .post-form textarea:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: var(--glow);
    }

    .post-form .file-upload-label {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 12px;
      background: var(--background-color);
      border: 1px solid var(--hover-bg);
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: var(--transition-speed);
    }

    .post-form .file-upload-label:hover {
      background: var(--hover-bg);
      border-color: var(--primary-color);
    }

    .post-form .file-upload-label .upload-icon {
      font-size: 18px;
    }

    .post-form .file-upload-label .upload-text {
      font-size: 14px;
      color: var(--text-color);
    }

    .post-form .file-upload-input {
      display: none;
    }

    .post-form .post-button {
      width: 100%;
      padding: 12px 20px;
      background: var(--gradient-primary);
      color: white;
      font-size: 16px;
      font-weight: bold;
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: var(--transition-speed);
      box-shadow: var(--glow);
    }

    .post-form .post-button:hover {
      opacity: 0.9;
      transform: translateY(-2px);
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .navbar .menu {
        gap: 10px;
        overflow-x: auto;
        white-space: nowrap;
      }

      .navbar a {
        font-size: 12px;
        padding: 6px 10px;
      }

      .navbar .logout-btn {
        padding: 6px 10px;
        font-size: 12px;
      }

      .container {
        padding: 15px;
      }

      .story-box {
        top: 90px;
        right: 15px;
        width: 50px;
        height: 50px;
      }

      .story-box .add-icon {
        font-size: 20px;
      }

      .story-card {
        width: 100px;
        height: 150px;
      }

      .story-card .user-info img {
        width: 25px;
        height: 25px;
      }

      .story-card .user-info span {
        font-size: 12px;
      }
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <div class="navbar">
    <div class="logo">Hashbook</div>
    <div class="menu">
      <a href="../dashboard.html">Home</a>
      <a href="./profile/index.html">Profile</a>
      <a href="./Messaging/index.html">Messages</a>
      <a href="./settings/index.html">Settings</a>
      <a href="./Friends/index.html">Friends</a>
      <div class="logout-btn">Logout</div>
    </div>
  </div>

  <!-- Story Box -->
  <div class="story-box" id="story-box">
    <span class="add-icon">+</span>
  </div>

  <!-- Story Modal for Viewing -->
  <div class="story-view-modal" id="story-view-modal">
    <div class="story-content">
      <span class="close-story-modal" id="close-story-modal">&times;</span>
      <div class="story-media" id="story-media">
        <!-- Image or text will be dynamically inserted here -->
      </div>
      <div class="story-controls">
        <button id="play-pause-btn" class="control-btn">⏸️</button>
      </div>
    </div>
  </div>

  <!-- Story Modal -->
  <div class="story-modal" id="story-modal">
    <div class="modal-content">
      <span class="close-modal" id="close-modal">&times;</span>
      <h3>Create a Story</h3>
      <textarea id="story-text" rows="4" placeholder="Write your story..."></textarea>
      <label for="story-image" class="file-upload-label">
        <span class="upload-icon">📷</span>
        <span class="upload-text">Upload Image (Optional)</span>
        <input type="file" id="story-image" accept="image/*" class="file-upload-input">
      </label>
      <button id="story-btn" class="story-button">Post Story</button>
    </div>
  </div>

  <!-- Main Container -->
  <div class="container">
    <!-- Stories Container -->
    <div class="stories-container" id="stories-container"></div>

    <!-- Post Form -->
    <div class="post-form">
      <h3>Share With Us</h3>
      <div class="form-group">
        <textarea id="post-text" rows="4" placeholder="What's on your mind?"></textarea>
      </div>
      <div class="form-group">
        <label for="post-image" class="file-upload-label">
          <span class="upload-icon">📷</span>
          <span class="upload-text">Upload Image</span>
          <input type="file" id="post-image" accept="image/*" class="file-upload-input">
        </label>
      </div>
      <button id="post-btn" class="post-button">Post</button>
    </div>

    <!-- Posts Section -->
    <div class="posts-container" id="posts-container"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      getDocs,
      query,
      orderBy,
      serverTimestamp,
      doc,
      deleteDoc,
      updateDoc,
      arrayUnion,
      arrayRemove,
      getDoc,
      onSnapshot,
    } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
    import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
    import { formatDistanceToNow } from 'https://cdn.skypack.dev/date-fns';

    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCKv8qaAw8bcHwprm1IRA1NWyXQ47tBWRY",
      authDomain: "facebook-1751a.firebaseapp.com",
      databaseURL: "https://facebook-1751a-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "facebook-1751a",
      storageBucket: "facebook-1751a.appspot.com",
      messagingSenderId: "852573765318",
      appId: "1:852573765318:web:00d8edf77b925d7a5e21c7",
      measurementId: "G-RZBV4M5Z2F"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // Redirect if not authenticated
    onAuthStateChanged(auth, (user) => {
      if (!user) {
        window.location.replace("./index.html"); // Redirect to login page
      } else {
        loadPosts(); // Load posts after authentication
        loadStories(); // Load stories after authentication
      }
    });

    // Logout Function
    const logoutButtons = document.querySelectorAll(".logout-btn");
    logoutButtons.forEach((button) => {
      button.addEventListener("click", () => {
        signOut(auth)
          .then(() => {
            window.location.replace("./index.html"); // Redirect to login page
          })
          .catch((error) => {
            console.error("Error signing out:", error);
          });
      });
    });

    // Fetch User Data from Firestore
    async function getUserData(userId) {
      try {
        const userRef = doc(db, "users", userId);
        const userDoc = await getDoc(userRef);

        if (userDoc.exists()) {
          const userData = userDoc.data();
          console.log("Fetched user data:", userData); // Log user data
          return userData;
        } else {
          console.log("User document does not exist for ID:", userId); // Log missing document
          return null;
        }
      } catch (error) {
        console.error("Error fetching user data:", error);
        return null;
      }
    }

    // Resolve Display Name
    function resolveDisplayName(user, userData) {
      // Priority: displayName > authName (from Firebase Authentication) > username > Anonymous
      return (
        userData?.displayName || // From Firestore
        user?.displayName || // From Firebase Authentication
        userData?.username || // From Firestore (username field)
        "Anonymous" // Default
      );
    }

    // Load Posts from Firestore (Realtime)
    function loadPosts() {
      const postsRef = collection(db, "posts");
      const q = query(postsRef, orderBy("createdAt", "desc"));

      // Use onSnapshot for real-time updates
      onSnapshot(q, (querySnapshot) => {
        const postsContainer = document.getElementById("posts-container");
        postsContainer.innerHTML = "";

        if (querySnapshot.empty) {
          postsContainer.innerHTML = "<p>No posts found.</p>";
          return;
        }

        querySnapshot.forEach(async (doc) => {
          const post = doc.data();
          const userData = await getUserData(post.userId); // Fetch user data
          const displayName = resolveDisplayName(auth.currentUser, userData); // Resolve display name
          const photoURL = userData?.photoURL || "pfp.jpg"; // Default profile picture

          const postElement = createPostElement(post, doc.id, displayName, photoURL);
          postsContainer.appendChild(postElement);
        });
      });
    }

    // Create a Post Element
    function createPostElement(post, postId, displayName, photoURL) {
      const postElement = document.createElement("div");
      postElement.classList.add("post");

      const userInfo = document.createElement("div");
      userInfo.classList.add("user-info");

      // User Profile Picture
      const userImage = document.createElement("img");
      userImage.src = photoURL; // Use fetched or default profile picture
      userImage.alt = "Profile Picture";
      userImage.classList.add("profile-pic");
      userInfo.appendChild(userImage);

      // User Display Name
      const username = document.createElement("span");
      username.textContent = displayName; // Use resolved display name
      username.classList.add("username");
      userInfo.appendChild(username);

      // Dropdown for Edit/Delete (only for the logged-in user's posts)
      if (post.userId === auth.currentUser.uid) {
        const dropdown = document.createElement("div");
        dropdown.classList.add("dropdown");

        const dropdownButton = document.createElement("button");
        dropdownButton.classList.add("dropdown-btn");
        dropdownButton.innerHTML = "&#8942;"; // Three dots icon
        dropdown.appendChild(dropdownButton);

        const dropdownContent = document.createElement("div");
        dropdownContent.classList.add("dropdown-content");

        const editButton = document.createElement("button");
        editButton.textContent = "Edit";
        editButton.addEventListener("click", () => editPost(postId, post.text));
        dropdownContent.appendChild(editButton);

        const deleteButton = document.createElement("button");
        deleteButton.textContent = "Delete";
        deleteButton.addEventListener("click", () => deletePost(postId, post.deleteUrl));
        dropdownContent.appendChild(deleteButton);

        dropdown.appendChild(dropdownContent);
        postElement.appendChild(dropdown);

        // Show dropdown on click
        dropdownButton.addEventListener("click", (e) => {
          e.stopPropagation(); // Prevent event bubbling
          dropdownContent.style.display = dropdownContent.style.display === "block" ? "none" : "block";
        });

        // Hide dropdown when clicking outside
        document.addEventListener("click", () => {
          dropdownContent.style.display = "none";
        });
      }

      // Post Text
      const postText = document.createElement("p");
      postText.textContent = post.text;
      postText.classList.add("post-text");
      postElement.appendChild(postText);

      // Display Post Image (if available)
      if (post.imageUrl) {
        const postImage = document.createElement("img");
        postImage.src = post.imageUrl;
        postImage.alt = "Post Image";
        postImage.classList.add("post-image");
        postElement.appendChild(postImage);
      }

      // Time Ago
      const timeAgo = document.createElement("span");
      timeAgo.textContent = formatDistanceToNow(post.createdAt.toDate(), {
        addSuffix: true,
      });
      timeAgo.classList.add("time-ago");
      postElement.appendChild(timeAgo);

      // Like Button
      const likeButton = document.createElement("button");
      likeButton.classList.add("like-btn");
      likeButton.innerHTML = post.likes && post.likes.includes(auth.currentUser.uid)
        ? '<span style="color: red;">❤️</span>' // Red heart if liked
        : '<span>🤍</span>'; // White heart if not liked
      likeButton.addEventListener("click", () => toggleLike(postId));
      postElement.appendChild(likeButton);

      // Likes Count
      const likesCount = document.createElement("span");
      likesCount.textContent = `${post.likes ? post.likes.length : 0} likes`;
      likesCount.classList.add("likes-count");
      postElement.appendChild(likesCount);

      // Comments Section
      const commentsContainer = document.createElement("div");
      commentsContainer.classList.add("comments-container");

      const commentsHeader = document.createElement("h4");
      commentsHeader.textContent = "Comments:";
      commentsContainer.appendChild(commentsHeader);

      // Display Existing Comments
      if (post.comments) {
        post.comments.forEach((comment) => {
          const commentElement = document.createElement("p");
          const commentTime = formatDistanceToNow(new Date(comment.createdAt), {
            addSuffix: true,
          });
          commentElement.textContent = `${comment.displayName}: ${comment.text} (${commentTime})`;
          commentsContainer.appendChild(commentElement);
        });
      }

      // Comment Input
      const commentInput = document.createElement("input");
      commentInput.type = "text";
      commentInput.placeholder = "Add a comment...";
      commentInput.classList.add("comment-input");
      commentsContainer.appendChild(commentInput);

      const commentButton = document.createElement("button");
      commentButton.textContent = "Comment";
      commentButton.classList.add("comment-btn");
      commentButton.addEventListener("click", () => addComment(postId, commentInput.value));
      commentsContainer.appendChild(commentButton);

      postElement.appendChild(commentsContainer);
      return postElement;
    }

    // Toggle Like
    async function toggleLike(postId) {
      const userId = auth.currentUser.uid;
      const postRef = doc(db, "posts", postId);
      const postSnapshot = await getDoc(postRef);
      const postData = postSnapshot.data();

      let likes = postData.likes || [];
      if (likes.includes(userId)) {
        // User already liked, remove like
        likes = likes.filter((id) => id !== userId);
        await updateDoc(postRef, { likes: arrayRemove(userId) });
      } else {
        // User hasn't liked, add like
        likes.push(userId);
        await updateDoc(postRef, { likes: arrayUnion(userId) });
      }

      loadPosts(); // Reload posts to update UI
    }

    // Add Comment
    async function addComment(postId, commentText) {
      if (!commentText) {
        Swal.fire("Error", "Please enter a comment.", "error");
        return;
      }

      const user = auth.currentUser;
      const userData = await getUserData(user.uid); // Fetch user data for the comment
      if (!userData) {
        Swal.fire("Error", "Failed to fetch user data.", "error");
        return;
      }

      const postRef = doc(db, "posts", postId);

      // Create the comment object
      const comment = {
        text: commentText,
        userId: user.uid,
        displayName: resolveDisplayName(user, userData), // Resolve display name
        createdAt: new Date().toISOString(), // Use client-side timestamp
      };

      // Use arrayUnion to add the comment
      await updateDoc(postRef, {
        comments: arrayUnion(comment),
      });

      loadPosts(); // Reload posts to update UI
    }

    // Handle Creating a Post
    document.getElementById("post-btn").addEventListener("click", async () => {
      const postText = document.getElementById("post-text").value;
      const postImage = document.getElementById("post-image").files[0];

      if (!postText) {
        Swal.fire("Error", "Please enter some text for your post.", "error");
        return;
      }

      const user = auth.currentUser;
      if (!user) {
        Swal.fire("Error", "You must be logged in to create a post.", "error");
        return;
      }

      const userData = await getUserData(user.uid);
      if (!userData) {
        Swal.fire("Error", "Failed to fetch user data.", "error");
        return;
      }

      let imageUrl = null;
      let deleteUrl = null;
      if (postImage) {
        // Upload image to ImgBB
        const formData = new FormData();
        formData.append("image", postImage);

        try {
          const response = await fetch("https://api.imgbb.com/1/upload?key=63f32114ab94d00d1a0e23d5ac0c4d45", {
            method: "POST",
            body: formData,
          });

          if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
          }

          const data = await response.json();

          // Check if the response contains the expected data
          if (!data || !data.data || !data.data.url) {
            throw new Error("Invalid response from ImgBB API");
          }

          imageUrl = data.data.url; // Get the uploaded image URL
          deleteUrl = data.data.delete_url; // Get the delete URL
        } catch (error) {
          console.error("Error uploading image:", error);
          Swal.fire("Error", "Failed to upload image. Please try again.", "error");
          return;
        }
      }

      try {
        await addDoc(collection(db, "posts"), {
          text: postText,
          imageUrl: imageUrl, // Store the image URL in Firestore
          deleteUrl: deleteUrl, // Store the delete URL in Firestore
          createdAt: serverTimestamp(),
          userId: user.uid,
          displayName: resolveDisplayName(user, userData), // Store resolved display name
          photoURL: userData.photoURL || "pfp.jpg", // Store profile picture
          likes: [], // Initialize likes array
          comments: [], // Initialize comments array
        });

        // Clear input and reload posts
        document.getElementById("post-text").value = "";
        document.getElementById("post-image").value = "";
        loadPosts();
      } catch (error) {
        console.error("Error creating post:", error);
        Swal.fire("Error", "Failed to create post. Please try again.", "error");
      }
    });

    // Delete Post
    async function deletePost(postId, deleteUrl) {
      const { isConfirmed } = await Swal.fire({
        title: "Are you sure?",
        text: "You will not be able to recover this post!",
        icon: "warning",
        showCancelButton: true,
        confirmButtonText: "Yes, delete it!",
        cancelButtonText: "No, cancel!",
      });

      if (isConfirmed) {
        // Delete the image from ImgBB (if it exists)
        if (deleteUrl) {
          try {
            await fetch(deleteUrl, { method: "DELETE" });
          } catch (error) {
            console.error("Error deleting image from ImgBB:", error);
          }
        }

        // Delete the post from Firestore
        await deleteDoc(doc(db, "posts", postId));
        loadPosts();
        Swal.fire("Deleted!", "Your post has been deleted.", "success");
      }
    }

    // Edit Post
    async function editPost(postId, currentText) {
      const { value: newText } = await Swal.fire({
        title: "Edit your post",
        input: "textarea",
        inputValue: currentText,
        showCancelButton: true,
        inputValidator: (value) => {
          if (!value) {
            return "You need to write something!";
          }
        },
      });

      if (newText && newText !== currentText) {
        await updateDoc(doc(db, "posts", postId), { text: newText });
        loadPosts();
      }
    }

    // Handle Creating a Story
    document.getElementById("story-box").addEventListener("click", () => {
      document.getElementById("story-modal").classList.add("active");
    });

    // Close Story Modal
    document.getElementById("close-modal").addEventListener("click", () => {
      document.getElementById("story-modal").classList.remove("active");
    });

    // Handle Posting a Story
    document.getElementById("story-btn").addEventListener("click", async () => {
      const storyText = document.getElementById("story-text").value;
      const storyImage = document.getElementById("story-image").files[0];

      if (!storyText) {
        Swal.fire("Error", "Please write something for your story.", "error");
        return;
      }

      const user = auth.currentUser;
      if (!user) {
        Swal.fire("Error", "You must be logged in to create a story.", "error");
        return;
      }

      const userData = await getUserData(user.uid);
      if (!userData) {
        Swal.fire("Error", "Failed to fetch user data.", "error");
        return;
      }

      let imageUrl = null;
      let deleteUrl = null;
      if (storyImage) {
        // Upload image to ImgBB
        const formData = new FormData();
        formData.append("image", storyImage);

        try {
          const response = await fetch("https://api.imgbb.com/1/upload?key=63f32114ab94d00d1a0e23d5ac0c4d45", {
            method: "POST",
            body: formData,
          });

          if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
          }

          const data = await response.json();

          // Check if the response contains the expected data
          if (!data || !data.data || !data.data.url) {
            throw new Error("Invalid response from ImgBB API");
          }

          imageUrl = data.data.url; // Get the uploaded image URL
          deleteUrl = data.data.delete_url; // Get the delete URL
        } catch (error) {
          console.error("Error uploading image:", error);
          Swal.fire("Error", "Failed to upload image. Please try again.", "error");
          return;
        }
      }

      try {
        await addDoc(collection(db, "stories"), {
          text: storyText,
          imageUrl: imageUrl, // Store the image URL in Firestore
          deleteUrl: deleteUrl, // Store the delete URL in Firestore
          createdAt: serverTimestamp(),
          userId: user.uid,
          displayName: resolveDisplayName(user, userData), // Store resolved display name
          expiresAt: new Date(Date.now() + 24 * 60 * 60 * 1000), // 24 hours from now
        });

        // Clear input and close modal
        document.getElementById("story-text").value = "";
        document.getElementById("story-image").value = "";
        document.getElementById("story-modal").classList.remove("active");
        loadStories();
      } catch (error) {
        console.error("Error creating story:", error);
        Swal.fire("Error", "Failed to create story. Please try again.", "error");
      }
    });

    // Load Stories from Firestore (Realtime)
    function loadStories() {
      const storiesRef = collection(db, "stories");
      const q = query(storiesRef, orderBy("createdAt", "desc"));

      // Use onSnapshot for real-time updates
      onSnapshot(q, (querySnapshot) => {
        const storiesContainer = document.getElementById("stories-container");
        storiesContainer.innerHTML = ""; // Clear the container before appending new stories

        if (querySnapshot.empty) {
          storiesContainer.innerHTML = "<p>No stories found.</p>";
          return;
        }

        querySnapshot.forEach(async (doc) => {
          const story = doc.data();
          const userData = await getUserData(story.userId); // Fetch user data
          const displayName = resolveDisplayName(auth.currentUser, userData); // Resolve display name
          const photoURL = userData?.photoURL || "pfp.jpg"; // Default profile picture

          const storyElement = createStoryElement(story, doc.id, displayName, photoURL);
          storiesContainer.appendChild(storyElement);
        });
      });
    }

    // Create a Story Element
    function createStoryElement(story, storyId, displayName, photoURL) {
      const storyElement = document.createElement("div");
      storyElement.classList.add("story-card");
      storyElement.setAttribute("data-story-id", storyId); // Add unique ID to story card

      // Story Image
      if (story.imageUrl) {
        const storyImage = document.createElement("img");
        storyImage.src = story.imageUrl;
        storyImage.alt = "Story Image";
        storyElement.appendChild(storyImage);
      }

      // User Info
      const userInfo = document.createElement("div");
      userInfo.classList.add("user-info");

      const userImage = document.createElement("img");
      userImage.src = photoURL;
      userImage.alt = "Profile Picture";
      userInfo.appendChild(userImage);

      const username = document.createElement("span");
      username.textContent = displayName;
      userInfo.appendChild(username);

      storyElement.appendChild(userInfo);

      // Dropdown for Delete (only for the logged-in user's stories)
      if (story.userId === auth.currentUser.uid) {
        const dropdown = document.createElement("div");
        dropdown.classList.add("dropdown");

        const dropdownButton = document.createElement("button");
        dropdownButton.classList.add("dropdown-btn");
        dropdownButton.innerHTML = "&#8942;"; // Three dots icon
        dropdown.appendChild(dropdownButton);

        const dropdownContent = document.createElement("div");
        dropdownContent.classList.add("dropdown-content");

        const deleteButton = document.createElement("button");
        deleteButton.textContent = "Delete";
        deleteButton.addEventListener("click", () => deleteStory(storyId, story.deleteUrl));
        dropdownContent.appendChild(deleteButton);

        dropdown.appendChild(dropdownContent);
        storyElement.appendChild(dropdown);

        // Show dropdown on click
        dropdownButton.addEventListener("click", (e) => {
          e.stopPropagation(); // Prevent event bubbling
          dropdownContent.style.display = dropdownContent.style.display === "block" ? "none" : "block";
        });

        // Hide dropdown when clicking outside
        document.addEventListener("click", () => {
          dropdownContent.style.display = "none";
        });
      }

      // Add click event listener to open the story
      storyElement.addEventListener("click", () => {
        openStory(story);
      });

      return storyElement;
    }

    // Delete Story
    async function deleteStory(storyId, deleteUrl) {
      const { isConfirmed } = await Swal.fire({
        title: "Are you sure?",
        text: "You will not be able to recover this story!",
        icon: "warning",
        showCancelButton: true,
        confirmButtonText: "Yes, delete it!",
        cancelButtonText: "No, cancel!",
      });

      if (isConfirmed) {
        // Delete the image from ImgBB (if it exists)
        if (deleteUrl) {
          try {
            await fetch(deleteUrl, { method: "DELETE" });
          } catch (error) {
            console.error("Error deleting image from ImgBB:", error);
          }
        }

        // Delete the story from Firestore
        await deleteDoc(doc(db, "stories", storyId));
        loadStories();
        Swal.fire("Deleted!", "Your story has been deleted.", "success");
      }
    }

    // Automatically Delete Expired Stories
    async function deleteExpiredStories() {
      const storiesRef = collection(db, "stories");
      const q = query(storiesRef, orderBy("expiresAt", "asc"));

      const querySnapshot = await getDocs(q);
      querySnapshot.forEach(async (doc) => {
        const story = doc.data();
        if (new Date(story.expiresAt.toDate()) < new Date()) {
          // Delete the story if it has expired
          await deleteDoc(doc.ref);
        }
      });
    }

    // Story Viewing Logic
    let storyTimer;
    let isPaused = false;

    // Open Story for Viewing
    function openStory(story) {
      const storyMedia = document.getElementById("story-media");
      const storyViewModal = document.getElementById("story-view-modal");
      const playPauseBtn = document.getElementById("play-pause-btn");

      // Clear previous content
      storyMedia.innerHTML = "";

      // Add story content
      if (story.imageUrl) {
        const img = document.createElement("img");
        img.src = story.imageUrl;
        img.alt = "Story Image";
        storyMedia.appendChild(img);
      } else {
        const text = document.createElement("p");
        text.textContent = story.text;
        storyMedia.appendChild(text);
      }

      // Show the modal
      storyViewModal.classList.add("active");

      // Set the timer based on story type
      const duration = story.imageUrl ? 5000 : 7000; // 5 seconds for image, 7 seconds for text
      startStoryTimer(duration);

      // Play/Pause Button
      playPauseBtn.innerHTML = "⏸️"; // Pause icon
      playPauseBtn.addEventListener("click", () => {
        if (isPaused) {
          resumeStoryTimer();
          playPauseBtn.innerHTML = "⏸️"; // Pause icon
        } else {
          pauseStoryTimer();
          playPauseBtn.innerHTML = "▶️"; // Play icon
        }
      });

      // Close Modal on Click Outside
      storyViewModal.addEventListener("click", (e) => {
        if (e.target === storyViewModal) {
          closeStoryModal();
        }
      });
    }

    // Close Story Modal
    function closeStoryModal() {
      const storyViewModal = document.getElementById("story-view-modal");
      storyViewModal.classList.remove("active");
      clearTimeout(storyTimer); // Clear the timer
      isPaused = false; // Reset pause state
    }

    // Start Story Timer
    function startStoryTimer(duration) {
      storyTimer = setTimeout(() => {
        closeStoryModal();
      }, duration);
    }

    // Pause Story Timer
    function pauseStoryTimer() {
      clearTimeout(storyTimer);
      isPaused = true;
    }

    // Resume Story Timer
    function resumeStoryTimer() {
      const remainingTime = isPaused ? 5000 : 7000; // Adjust based on story type
      startStoryTimer(remainingTime);
      isPaused = false;
    }

    // Check for expired stories every minute
    setInterval(deleteExpiredStories, 60 * 1000);
  </script>
</body>
</html>
