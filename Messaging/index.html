<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messages - Hashbook</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { background: #23272A; color: #fff; display: flex; height: 100vh; overflow: hidden; }
        .sidebar { width: 280px; background-color: #1E2124; padding: 40px 30px; position: fixed; top: 0; left: 0; height: 100%; overflow-y: auto; }
        .sidebar .logo { font-size: 30px; font-weight: 700; color: #7EC8C5; text-align: center; margin-bottom: 20px; }
        .sidebar a { display: block; color: #7EC8C5; padding: 14px 22px; text-decoration: none; transition: 0.3s; }
        .sidebar a:hover { background-color: #3D5A5B; }
        .container { margin-left: 300px; padding: 20px; width: calc(100% - 300px); display: flex; gap: 20px; height: 100%; }
        .friends-list { width: 280px; background: #1E2124; padding: 20px; border-radius: 10px; overflow-y: auto; }
        .friends-list h3 { font-size: 22px; color: #7EC8C5; margin-bottom: 10px; }
        .friends-list ul { list-style: none; }
        .friends-list li { padding: 10px; cursor: pointer; background: #2C2F33; border-radius: 5px; margin-bottom: 5px; transition: 0.3s; }
        .friends-list li:hover { background: #3D5A5B; }
        .chat-window { flex: 1; background: #1E2124; padding: 20px; border-radius: 10px; display: flex; flex-direction: column; }
        .chat-header { font-size: 22px; font-weight: 600; color: #7EC8C5; margin-bottom: 10px; }
        .chat-messages { flex: 1; overflow-y: auto; padding: 10px; background: #2C2F33; border-radius: 5px; }
        .message { margin-bottom: 10px; padding: 10px; border-radius: 5px; max-width: 70%; }
        .sent { background: #557D7A; align-self: flex-end; }
        .received { background: #7EC8C5; align-self: flex-start; }
        .chat-input { display: flex; gap: 10px; padding-top: 10px; }
        .chat-input textarea { flex: 1; padding: 10px; border-radius: 5px; background: #2C2F33; color: white; resize: none; }
        .chat-input button { padding: 10px 20px; background: #557D7A; color: white; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="logo">HASHBOOK</div>
        <a href="../dashboard.html">Home</a>
        <a href="../profile/index.html">Profile</a>
        <a href="index.html">Messages</a>
        <a href="settings.html">Settings</a>
        <div id="logout-btn" class="logout-btn">Logout</div>
    </div>

    <div class="container">
        <div class="friends-list">
            <h3>Friends</h3>
            <ul id="friends-list"></ul>
        </div>

        <div class="chat-window">
            <div class="chat-header">Chat with <span id="chat-friend-name">Friend</span></div>
            <div class="chat-messages" id="chat-messages"></div>
            <div class="chat-input">
                <textarea id="chat-input" placeholder="Type a message..." disabled></textarea>
                <button id="send-btn" disabled>Send</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs, addDoc, onSnapshot, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCKv8qaAw8bcHwprm1IRA1NWyXQ47tBWRY",
            authDomain: "facebook-1751a.firebaseapp.com",
            databaseURL: "https://facebook-1751a-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "facebook-1751a",
            storageBucket: "facebook-1751a.firebasestorage.app",
            messagingSenderId: "852573765318",
            appId: "1:852573765318:web:00d8edf77b925d7a5e21c7",
            measurementId: "G-RZBV4M5Z2F"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let selectedFriend = null;

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                loadFriends();
            } else {
                console.log("User is not authenticated.");
                // Redirect to login page or show login UI
            }
        });

        async function loadFriends() {
            const friendsList = document.getElementById("friends-list");
            friendsList.innerHTML = "<li>Loading friends...</li>";

            try {
                const querySnapshot = await getDocs(collection(db, "users"));
                friendsList.innerHTML = "";
                querySnapshot.forEach(doc => {
                    const friend = doc.data();
                    console.log("Friend Data:", friend); // Debugging
                    if (friend.email !== currentUser.email) { // Use email as a fallback
                        const li = document.createElement("li");
                        li.textContent = friend.name;
                        li.onclick = () => selectFriend(friend);
                        friendsList.appendChild(li);
                    }
                });
            } catch (error) {
                console.error("Error loading friends:", error);
                friendsList.innerHTML = "<li>Failed to load friends.</li>";
            }
        }

        function selectFriend(friend) {
            console.log("Selected Friend:", friend); // Debugging

            // Use email as a fallback if uid is missing
            if (!friend || (!friend.uid && !friend.email)) {
                console.error("Invalid friend selected: Missing uid or email.");
                return;
            }

            selectedFriend = friend;
            document.getElementById("chat-friend-name").textContent = friend.name;
            document.getElementById("chat-input").disabled = false;
            document.getElementById("send-btn").disabled = false;
            loadMessages();
        }

        function loadMessages() {
            if (!selectedFriend) return;
            const chatMessages = document.getElementById("chat-messages");

            const chatQuery = query(
                collection(db, "messages"),
                where("participants", "array-contains", currentUser.email), // Use email as a fallback
                orderBy("timestamp", "asc")
            );

            onSnapshot(chatQuery, (snapshot) => {
                chatMessages.innerHTML = "";
                snapshot.forEach(doc => {
                    const message = doc.data();
                    if ((message.sender === currentUser.email && message.receiver === selectedFriend.email) ||
                        (message.sender === selectedFriend.email && message.receiver === currentUser.email)) {
                        const msgDiv = document.createElement("div");
                        msgDiv.className = `message ${message.sender === currentUser.email ? 'sent' : 'received'}`;
                        msgDiv.textContent = message.text;
                        chatMessages.appendChild(msgDiv);
                    }
                });
                chatMessages.scrollTop = chatMessages.scrollHeight; // Scroll to the latest message
            });
        }

        document.getElementById("send-btn").addEventListener("click", async () => {
            if (!selectedFriend || (!selectedFriend.uid && !selectedFriend.email)) {
                console.error("No friend selected or friend UID/email is missing.");
                return;
            }

            const messageInput = document.getElementById("chat-input");
            const messageText = messageInput.value.trim();

            if (messageText === "") {
                console.error("Message cannot be empty.");
                return;
            }

            try {
                await addDoc(collection(db, "messages"), {
                    text: messageText,
                    sender: currentUser.email, // Use email as a fallback
                    receiver: selectedFriend.email, // Use email as a fallback
                    participants: [currentUser.email, selectedFriend.email], // Use email as a fallback
                    timestamp: serverTimestamp()
                });
                messageInput.value = ""; // Clear the input field
            } catch (error) {
                console.error("Error sending message:", error);
            }
        });

        document.getElementById("chat-input").addEventListener("keypress", async (e) => {
            if (e.key === "Enter" && !e.shiftKey) {
                e.preventDefault();
                document.getElementById("send-btn").click();
            }
        });
    </script>
</body>
</html>
